machine:
  node:
    version: 0.12.7
  python:
    version: 2.7.3
  services:
    - docker
    - mongodb
  environment:
    SHORT_SHA: $(echo $CIRCLE_SHA1 | cut -b1-7)
    TAG: ${CIRCLE_BRANCH:-$(echo $CIRCLE_TAG)}
    IMAGE_PATH: "formio/formio-server"
    AWS_DEFAULT_REGION: "us-west-2"
    MONGO: "mongodb://localhost:27017/formio"

dependencies:
  pre:
    - if [[ ! -d mongodb-linux-x86_64-ubuntu1204-3.0.5 ]]; then wget http://downloads.mongodb.org/linux/mongodb-linux-x86_64-ubuntu1204-3.0.5.tgz && tar xvzf mongodb-linux-x86_64-ubuntu1204-3.0.5.tgz; fi
    - sudo /etc/init.d/mongodb stop
    - sudo cp mongodb-linux-x86_64-ubuntu1204-3.0.5/bin/* /usr/bin
    - sudo /etc/init.d/mongodb start
    - pip install awscli
    - npm install -g mocha
  override:
    - echo $TAG_NAME
    - ./serverSetup.sh
    - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
    - docker build -t $IMAGE_PATH:$SHORT_SHA -f deployment/docker/formio-server/Dockerfile .
  post:
    - ./deployment/scripts/importDb.sh formio

test:
  pre:
    - sudo bash -c "echo \"127.0.0.1 formio.localhost\" >> /etc/hosts"
    - sudo bash -c "echo \"127.0.0.1 api.localhost\" >> /etc/hosts"
  post:
    - docker run -d -e "MONGO1=$MONGO" -e "PROTOCOL=http" -e "DOMAIN=localhost" -e "PORT=3000" -e "DEBUG=formio:*,formio:*:*" --name formio-server --net=host $IMAGE_PATH:$SHORT_SHA
    - sleep 10
    - docker logs formio-server
    - curl --retry 10 --retry-delay 5 -v http://api.localhost:3000/health
    - npm run-script docker
    - docker logs formio-server > $CIRCLE_ARTIFACTS/formio-server.log 2>$CIRCLE_ARTIFACTS/error.log

deployment:
  release:
    tag: /^\d+\.\d+\.\d+$/
    commands:
      - docker tag $IMAGE_PATH:$SHORT_SHA $IMAGE_PATH:$TAG
      - docker push $IMAGE_PATH:$TAG
      - ./deployment/scripts/createVersion.sh $TAG
  build:
    tag: /build-.*/
    commands:
      - docker tag $IMAGE_PATH:$SHORT_SHA $IMAGE_PATH:$TAG
      - docker push $IMAGE_PATH:$TAG
      - ./deployment/scripts/createVersion.sh $TAG
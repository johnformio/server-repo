general:
  branches:
    only:
      - develop
      - /feature\/.*/
      - /bugfix\/.*/
      - /build-.*/
      - /^\d+\.\d+\.\d+$/

machine:
  node:
    version: 0.12.7
  python:
    version: 2.7.3
  services:
    - docker
    - mongodb
  environment:
    SHORT_SHA: $(echo $CIRCLE_SHA1 | cut -b1-7)
    TAG_NAME: "$CIRCLE_BRANCH-$SHORT_SHA"
    IMAGE_PATH: "formio/formio-server"
    AWS_DEFAULT_REGION: "us-west-2"
    MONGO: "mongodb://localhost:27017/formio"
    APPPORT: 3001

dependencies:
  pre:
    - if [[ ! -d mongodb-linux-x86_64-ubuntu1204-3.0.5 ]]; then wget http://downloads.mongodb.org/linux/mongodb-linux-x86_64-ubuntu1204-3.0.5.tgz && tar xvzf mongodb-linux-x86_64-ubuntu1204-3.0.5.tgz; fi
    - sudo /etc/init.d/mongodb stop
    - sudo cp mongodb-linux-x86_64-ubuntu1204-3.0.5/bin/* /usr/bin
    - sudo /etc/init.d/mongodb start
    - wget http://selenium-release.storage.googleapis.com/2.46/selenium-server-standalone-2.46.0.jar
    - java -jar selenium-server-standalone-2.46.0.jar:
        background: true
    - pip install awscli
    - npm install -g bower gulp mocha
  override:
    - echo $TAG_NAME
    - ./serverSetup.sh
    - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
    - docker build -t $IMAGE_PATH:$SHORT_SHA -f deployment/docker/formio-server/Dockerfile .
    - git clone -b $CIRCLE_BRANCH git@github.com:formio/formio-app.git
    - cd formio-app && ./appSetup.sh
  post:
    - ./deployment/scripts/importDb.sh formio

test:
  pre:
    - sudo bash -c "echo \"127.0.0.1 formio.localhost\" >> /etc/hosts"
    - sudo bash -c "echo \"127.0.0.1 api.localhost\" >> /etc/hosts"
    - docker run -d -e "MONGO1=$MONGO" -e "PROTOCOL=http" -e "DOMAIN=localhost" -e "PORT=3000" -e "DEBUG=formio:*" --name formio-server --net=host $IMAGE_PATH:$SHORT_SHA
    - cd formio-app && PORT=$APPPORT npm start:
        background: true
    - sleep 10
    - docker logs formio-server
    - curl --retry 10 --retry-delay 5 -v http://localhost:$APPPORT
    - curl --retry 10 --retry-delay 5 -v http://api.localhost:3000/health

deployment:
  release:
    tag: /^\d+\.\d+\.\d+$/
    commands:
      - cd formio-app/dist && tar -czvf ../../${CIRCLE_BRANCH}.tgz *
      - aws s3 cp ${CIRCLE_BRANCH}.tgz s3://formio-app-releases/${CIRCLE_BRANCH}.tgz
      - docker tag $IMAGE_PATH:$SHORT_SHA $IMAGE_PATH:$CIRClE_BRANCH
      - docker push $IMAGE_PATH:$CIRCLE_BRANCH
      - ./deployment/scripts/createVersion.sh $CIRCLE_BRANCH
  build:
    tag: /build-.*/
    commands:
      - cd formio-app/dist && tar -czvf ../../${CIRClE_BRANCH}.tgz *
      - aws s3 cp ${CIRClE_BRANCH}.tgz s3://formio-app-releases/${CIRClE_BRANCH}.tgz
      - docker tag $IMAGE_PATH:$SHORT_SHA $IMAGE_PATH:$CIRClE_BRANCH
      - docker push $IMAGE_PATH:$CIRClE_BRANCH
      - ./deployment/scripts/createVersion.sh $CIRClE_BRANCH

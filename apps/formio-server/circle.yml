general:
  branches:
    only:
      - develop
      - /feature\/.*/
      - /^\d+\.\d+\.\d+$/
      - /bugfix\/.*/

machine:
  node:
    version: 0.12.7
  python:
    version: 2.7.3
  services:
    - docker
    - mongodb
  environment:
    SHORT_SHA: $(echo $CIRCLE_SHA1 | cut -b1-7)
    TAG_NAME: "$CIRCLE_BRANCH-$SHORT_SHA"
    IMAGE_PATH: "formio/formio-server"
    AWS_DEFAULT_REGION: "us-west-2"
    MONGO: "mongodb://localhost:27017/formio"

dependencies:
  pre:
    - if [[ ! -d mongodb-linux-x86_64-ubuntu1204-3.0.5 ]]; then wget http://downloads.mongodb.org/linux/mongodb-linux-x86_64-ubuntu1204-3.0.5.tgz && tar xvzf mongodb-linux-x86_64-ubuntu1204-3.0.5.tgz; fi
    - sudo /etc/init.d/mongodb stop
    - sudo cp mongodb-linux-x86_64-ubuntu1204-3.0.5/bin/* /usr/bin
    - sudo /etc/init.d/mongodb start
    - wget http://selenium-release.storage.googleapis.com/2.46/selenium-server-standalone-2.46.0.jar
    - java -jar selenium-server-standalone-2.46.0.jar:
        background: true
    - pip install awscli
    - npm install -g bower gulp
  override:
    - echo $TAG_NAME
    - npm install && git submodule update --init --recursive && cd node_modules/formio && npm install
    - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
    - docker build -t $IMAGE_PATH:$TAG_NAME -f deployment/docker/formio-server/Dockerfile .
    - git clone git@github.com:formio/formio-app.git
    - cd formio-app && npm install && bower install --allow-root -s -F && rm -rf bower_components/ngForm* && git submodule update --init --recursive && cd bower_components/ngFormBuilder && bower install && cd ../ngFormio && bower install && cd ../.. && gulp
  post:
    - ./deployment/scripts/importDb.sh formio

test:
  pre:
    - sudo bash -c "echo \"127.0.0.1 formio.localhost\" >> /etc/hosts"
    - sudo bash -c "echo \"127.0.0.1 api.localhost\" >> /etc/hosts"
    - docker run -d -e "MONGO1=$MONGO" -e "PROTOCOL=http" -e "DOMAIN=localhost" -e "PORT=3000" -e "DEBUG=formio:*" --name formio-server --net=host $IMAGE_PATH:$TAG_NAME; sleep 10
    - docker logs formio-server
    - cd formio-app && npm start:
        background: true
    - curl --retry 10 --retry-delay 5 -v http://localhost:3001
    - curl --retry 10 --retry-delay 5 -v http://api.localhost:3000/health

deployment:
  release:
    branch: /^\d+\.\d+\.\d+$/
    commands:
      - docker push $IMAGE_PATH:$CIRCLE_BRANCH
      - ./deployment/scripts/createVersion.sh $TAG_NAME
